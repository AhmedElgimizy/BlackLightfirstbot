const Discord = require('discord.js');
const client = new Discord.Client();
const prefix = 'BL!'

client.on('ready', () => {
  console.log(`Logged in as ${client.user.tag}!`);
client.user.setGame(`Nothing`,"http://twitch.tv/S-F")
  console.log('')
  console.log('')
  console.log('╔[═════════════════════════════════════════════════════════════════]╗')
  console.log(`[Start] ${new Date()}`);
  console.log('╚[═════════════════════════════════════════════════════════════════]╝')
  console.log('')
  console.log('╔[════════════════════════════════════]╗');
  console.log(`Logged in as * [ " ${client.user.username} " ]`);
  console.log('')
  console.log('Informations :')
  console.log('')
  console.log(`servers! [ " ${client.guilds.size} " ]`);
  console.log(`Users! [ " ${client.users.size} " ]`);
  console.log(`channels! [ " ${client.channels.size} " ]`);
  console.log('╚[════════════════════════════════════]╝')
  console.log('')
  console.log('╔[════════════]╗')
  console.log(' Bot Is Online')
  console.log('╚[════════════]╝')
  console.log('')
  console.log('')
});
const adminprefix = "BL!";
const devs = ['347379495528824832'];
client.on('message', message => {
  var argresult = message.content.split(` `).slice(1).join(' ');
    if (!devs.includes(message.author.id)) return;
    
if (message.content.startsWith(adminprefix + 'setgame')) {
  client.user.setGame(argresult);
    message.channel.sendMessage(`**${argresult} تم تغيير بلاينق البوت إلى **`)
} else 
  if (message.content.startsWith(adminprefix + 'setname')) {
client.user.setUsername(argresult).then
    message.channel.sendMessage(`**${argresult}** : تم تغيير أسم البوت إلى`)
return message.reply("**لا يمكنك تغيير الاسم يجب عليك الانتظآر لمدة ساعتين . **");
} else
  if (message.content.startsWith(adminprefix + 'avatar')) {
client.user.setAvatar(argresult);
  message.channel.sendMessage(`**${argresult}** : تم تغير صورة البوت`);
      } else     
if (message.content.startsWith(adminprefix + 'setT')) {
  client.user.setGame(argresult, "https://www.twitch.tv/idk");
    message.channel.sendMessage(`**تم تغيير تويتش البوت إلى  ${argresult}**`)
}
});

client.on('message', message => {
if (message.content.startsWith(prefix + 'help')) { //ALPHACODES
    let pages = [`
***__وصف عن البوت__***
**
:gem:  البوت فيه كثير ميزات حلوة و جميلة
 ا:rocket: البوت يعمل 24 ساعه 
بوت يمتلك مضد جحفله +سبام+نشر روابط+مضاد سب :gear: 
**
        ***__General orders__***
**
『!allbots/لعرض جميع البوتات الي بالسيرفر』
『!server/يعرض لك معلومات عن السيرفر』
『!bot/يعرض لك كل معلومات البوت』
『!skin <name>/يعرض لك سكنك بماين كرافت』
『!count/يعرض لك عدد الاشخاص بالسيرفر بدون بوتات』
『!invites/ يعرض لك  عدد انفايتاتك بالسيرفر 』
『!invite-codes/يعرض لك روابط الانفايتات حكك في السيرفر 』
『!cal/اله حاسبة』
『!trans <language> <any thing>/يترجم لك الي تبيه من اي لغة』
『!short/يختصر لك رابط كبير الى رابط صغير』
『!tag/يكتب لك الكلمة بشكل جميل وكبير』
『!google/للبحث في قوقل عن طريق الدسكورد』
『!perms/يعرض لك برمشناتك بالسيرفر』
『!yn/تسأل بوت والبوت يجاوبك بنعم او لا』
『!w/امر يخليك مثل بوت تكتب عبره مع امر ويسويك بوت』
『!za5/يزخرف لك كلمة او جملة』
『!rooms/يعرض لك كل الرومات الي بالسيرفر مع عددها』
『!roles/يعرض لك كل الرانكات بالسيرفر بشكل جميل』
『!emojilist/يعرض لك كل الايموجيات الي بالسيرفر』
『say/يكرر الكلام الي تكتبو』
『!image/صورة السيرفر』
『!members/��عرض لك عدد كل حالات الاشخاص وعدد البوتات وعدد الاشخاص』
『!id/معلومات عنك』
『!profile/عرض بروفايل حقك』
『!tc/انشاء روم مؤقت ويمكنك تحديد الاعدادات』
『!bans / عدد الاشخاص المبندة 』
『!voice /  يوم لك بكتابه مجموع عدد الاشخاص الموجودين برومات』
『!avatar/صورتك او صورة الي تمنشنو』
『!embed/يكرر الي تقولو بشكل حلو』
『!discrim/كود يضهر لك الاشخاص نفس تاقك』
『!emoji <any things>/لتحويل اي كلمه تقولها الي ايموجي』
『!inv/لدعوة البوت الى سيرفرك』
『!support/سيرفر الدعم』
『!contact/ارسال اقتراح او لمراسلة صاحب البوت』
**
  `
,`
        ***__Administrative Orders__***
**
『!move @user /  لسحب الشخص الى روومك』
『!voiceonline /  لتفعيل خاصيه فويس اونلاين يسحب عدد الاشخاص موجودين برومات』
『!bc / رسالة جماعية الى كل اعضاء السيرفر』
『!bcrole / لارسال رساله جماعي لرتبه محدده يجب تمنشنها 』
『!role @user <rank> / لأعطاء رتبة لعضو معين』
『!roleremove @user <rank> / لازالة الرتبة من شخص معين』
『!role all <rank> / لأعطاء رتبة للجميع』
『!role humans <rank> / لأعطاء رتبة للاشخاص فقط』
『!role bots <rank> / لأعطاء رتبة لجميع البوتات』
『!hchannel / اخفاء الشات』
『!schannel / اضهار الشات المخفية』
『!clr <numbr> / مسح الشات بعدد』
『!clear / مسح الشات』
『!mute @user <reason> / اعطاء العضو ميوت لازم رتبة <Muted>』
『!unmute @user / لفك الميوت عن الشخص 』
『!kick @user <reason> / طرد الشخص من السيرفر』
『!ban @user <reason> / حضر الشخص من السيرفر』
『!mutechannel / تقفيل الشات』
『!unmutechannel / فتح الشات』
『!dc / مسح كل الرومات』
『!dr / <مسح كل الرانكات <لازم تكون رانك البوت فوق كل الرانكات』
『!ct <name> / انشاء شات』
『!cv <name> / انشاء رووم فويس』
『!delet <name> / مسح الشات او الرووم فويس』
『❖!ccolors <number> / ينشا لك الوان مع كم الوان تبي』
   `,`
        ***__Music orders__***
**
『${prefix}play / لتشغيل أغنية برآبط أو بأسم』
『${prefix}skip / لتجآوز الأغنية الحآلية』
『${prefix}pause / إيقآف الأغنية مؤقتا』
『${prefix}resume / لموآصلة الإغنية بعد إيقآفهآ مؤقتا』
『${prefix}vol / لتغيير درجة الصوت 100 - 0』
『${prefix}stop / لإخرآج البوت من الروم』
『${prefix}np / لمعرفة الأغنية المشغلة حآليا』
『${prefix}queue / لمعرفة قآئمة التشغيل』
**
        ***__Games orders__***
 **       
『!rps / حجر ورقة مقص』
『!speed / اسرع كتابة』
『!quas / اسئلة عامة』
『!نكت / نكت 』
『!لعبة فكك / فكك』
『!عواصم عشوائي/عواصم』
『!لعبة كت تويت / كت تويت』
『!roll <number> / قرعة』
『!لو خيروك بطريقة حلوة / لو خيروك』
『!لعبة مريم / مريم』
『!فوائد ونصائح  / هل تعلم』
『!يعطيك عقابات قاسية / عقاب 』


**
   
`]
    let page = 1;

    let embed = new Discord.RichEmbed()
    .setColor('RANDOM')
    .setFooter(`Page ${page} of ${pages.length}`)
    .setDescription(pages[page-1])

    message.author.sendEmbed(embed).then(msg => {

        msg.react('◀').then( r => {
            msg.react('▶')


        const backwardsFilter = (reaction, user) => reaction.emoji.name === '◀' && user.id === message.author.id;
        const forwardsFilter = (reaction, user) => reaction.emoji.name === '▶' && user.id === message.author.id;


        const backwards = msg.createReactionCollector(backwardsFilter, { time: 2000000});
        const forwards = msg.createReactionCollector(forwardsFilter, { time: 2000000});



        backwards.on('collect', r => {
            if (page === 1) return;
            page--;
            embed.setDescription(pages[page-1]);
            embed.setFooter(`Page ${page} of ${pages.length}`);
            msg.edit(embed)
        })
        forwards.on('collect', r => {
            if (page === pages.length) return;
      
      page++;
            embed.setDescription(pages[page-1]);
            embed.setFooter(`Page ${page} of ${pages.length}`);
            msg.edit(embed)
        })
        })
    })
    }
});
const Util = require('discord.js');
 
const getYoutubeID = require('get-youtube-id');
 
const fetchVideoInfo = require('youtube-info');
 
const YouTube = require('simple-youtube-api');
 
const youtube = new YouTube("AIzaSyAdORXg7UZUo7sePv97JyoDqtQVi3Ll0b8");
 
const queue = new Map();
 
const ytdl = require('ytdl-core');
 
const fs = require('fs');
 
const gif = require("gif-search");
 
const client = new Discord.Client({disableEveryone: true});
 
const prefix = "!";
/////////////////////////
////////////////////////
 
client.on('message', async msg =>{
    if (msg.author.bot) return undefined;
    if (!msg.content.startsWith(prefix)) return undefined;
   
    let args = msg.content.split(' ');
 
    let command = msg.content.toLowerCase().split(" ")[0];
    command = command.slice(prefix.length)
 
    if(command === `ping`) {
    let embed = new Discord.RichEmbed()
    .setColor(3447003)
    .setTitle("Pong!!")
    .setDescription(`${client.ping} ms,`)
    .setFooter(`Requested by | ${msg.author.tag}`);
    msg.delete().catch(O_o=>{})
    msg.channel.send(embed);
    }
});
/////////////////////////
////////////////////////
//////////////////////
client.on('message', async msg =>{
    if (msg.author.bot) return undefined;
    if (!msg.content.startsWith(prefix)) return undefined;
   
    let args = msg.content.split(' ');
 
    let command = msg.content.toLowerCase().split(" ")[0];
    command = command.slice(prefix.length)
 
    if(command === `avatar`){
    if(msg.channel.type === 'dm') return msg.channel.send("Nope Nope!! u can't use avatar command in DMs (:")
        let mentions = msg.mentions.members.first()
        if(!mentions) {
          let sicon = msg.author.avatarURL
          let embed = new Discord.RichEmbed()
          .setImage(msg.author.avatarURL)
          .setColor("#5074b3")
          msg.channel.send({embed})
        } else {
          let sicon = mentions.user.avatarURL
          let embed = new Discord.RichEmbed()
          .setColor("#5074b3")
          .setImage(sicon)
          msg.channel.send({embed})
        }
    };
});
/////////////////////////
////////////////////////
//////////////////////
/////////////////////////
////////////////////////
//////////////////////
 
/////////////////////////
////////////////////////
//////////////////////
/////////////////////////
////////////////////////
//////////////////////
client.on('message', async msg => {
    if (msg.author.bot) return undefined;
    if (!msg.content.startsWith(prefix)) return undefined;
   
    const args = msg.content.split(' ');
    const searchString = args.slice(1).join(' ');
   
    const url = args[1] ? args[1].replace(/<(.+)>/g, '$1') : '';
    const serverQueue = queue.get(msg.guild.id);
 
    let command = msg.content.toLowerCase().split(" ")[0];
    command = command.slice(prefix.length)
 
    if (command === `play`) {
        const voiceChannel = msg.member.voiceChannel;
       
        if (!voiceChannel) return msg.channel.send("I can't find you in any voice channel!");
       
        const permissions = voiceChannel.permissionsFor(msg.client.user);
       
        if (!permissions.has('CONNECT')) {
 
            return msg.channel.send("I don't have enough permissions to join your voice channel!");
        }
       
        if (!permissions.has('SPEAK')) {
 
            return msg.channel.send("I don't have enough permissions to speak in your voice channel!");
        }
 
        if (!permissions.has('EMBED_LINKS')) {
 
            return msg.channel.sendMessage("I don't have enough permissions to insert a URLs!")
        }
 
        if (url.match(/^https?:\/\/(www.youtube.com|youtube.com)\/playlist(.*)$/)) {
 
            const playlist = await youtube.getPlaylist(url);
            const videos = await playlist.getVideos();
           
 
            for (const video of Object.values(videos)) {
               
                const video2 = await youtube.getVideoByID(video.id);
                await handleVideo(video2, msg, voiceChannel, true);
            }
            return msg.channel.send(`**${playlist.title}**, Just added to the queue!`);
        } else {
 
            try {
 
                var video = await youtube.getVideo(url);
               
            } catch (error) {
                try {
 
                    var videos = await youtube.searchVideos(searchString, 5);
                    let index = 0;
                    const embed1 = new Discord.RichEmbed()
                    .setTitle(":mag_right:  YouTube Search Results :")
                    .setDescription(`
                    ${videos.map(video2 => `${++index}. **${video2.title}**`).join('\n')}`)
                   
                    .setColor("#f7abab")
                    msg.channel.sendEmbed(embed1).then(message =>{message.delete(20000)})
                   
/////////////////                  
                    try {
 
                        var response = await msg.channel.awaitMessages(msg2 => msg2.content > 0 && msg2.content < 11, {
                            maxMatches: 1,
                            time: 15000,
                            errors: ['time']
                        });
                    } catch (err) {
                        console.error(err);
                        return msg.channel.send('No one respone a number!!');
                    }
                   
                    const videoIndex = parseInt(response.first().content);
                    var video = await youtube.getVideoByID(videos[videoIndex - 1].id);
                   
                } catch (err) {
 
                    console.error(err);
                    return msg.channel.send("I didn't find any results!");
                }
            }
 
            return handleVideo(video, msg, voiceChannel);
           
        }
       
    } else if (command === `skip`) {
 
        if (!msg.member.voiceChannel) return msg.channel.send("You Must be in a Voice channel to Run the Music commands!");
        if (!serverQueue) return msg.channel.send("There is no Queue to skip!!");
 
        serverQueue.connection.dispatcher.end('Ok, skipped!');
        return undefined;
       
    } else if (command === `stop`) {
 
        if (!msg.member.voiceChannel) return msg.channel.send("You Must be in a Voice channel to Run the Music commands!");
        if (!serverQueue) return msg.channel.send("There is no Queue to stop!!");
       
        serverQueue.songs = [];
        serverQueue.connection.dispatcher.end('Ok, stopped & disconnected from your Voice channel');
        return undefined;
       
    } else if (command === `vol`) {
 
        if (!msg.member.voiceChannel) return msg.channel.send("You Must be in a Voice channel to Run the Music commands!");
        if (!serverQueue) return msg.channel.send('You only can use this command while music is playing!');
        if (!args[1]) return msg.channel.send(`The bot volume is **${serverQueue.volume}**`);
       
        serverQueue.volume = args[1];
        serverQueue.connection.dispatcher.setVolumeLogarithmic(args[1] / 50);
       
        return msg.channel.send(`Volume Now is **${args[1]}**`);
 
    } else if (command === `np`) {
 
        if (!serverQueue) return msg.channel.send('There is no Queue!');
        const embedNP = new Discord.RichEmbed()
        .setDescription(`Now playing **${serverQueue.songs[0].title}**`)
        return msg.channel.sendEmbed(embedNP);
       
    } else if (command === `queue`) {
       
        if (!serverQueue) return msg.channel.send('There is no Queue!!');
        let index = 0;
//  //  //
        const embedqu = new Discord.RichEmbed()
        .setTitle("The Queue Songs :")
        .setDescription(`
        ${serverQueue.songs.map(song => `${++index}. **${song.title}**`).join('\n')}
**Now playing :** **${serverQueue.songs[0].title}**`)
        .setColor("#f7abab")
        return msg.channel.sendEmbed(embedqu);
    } else if (command === `pause`) {
        if (serverQueue && serverQueue.playing) {
            serverQueue.playing = false;
            serverQueue.connection.dispatcher.pause();
            return msg.channel.send('Ok, paused');
        }
        return msg.channel.send('There is no Queue to Pause!');
    } else if (command === "resume") {
 
        if (serverQueue && !serverQueue.playing) {
            serverQueue.playing = true;
            serverQueue.connection.dispatcher.resume();
            return msg.channel.send('Ok, resumed!');
           
        }
        return msg.channel.send('Queue is empty!');
    }
 
    return undefined;
});
 
async function handleVideo(video, msg, voiceChannel, playlist = false) {
    const serverQueue = queue.get(msg.guild.id);
    console.log(video);
   
 
    const song = {
        id: video.id,
        title: Util.escapeMarkdown(video.title),
        url: `https://www.youtube.com/watch?v=${video.id}`
    };
    if (!serverQueue) {
        const queueConstruct = {
            textChannel: msg.channel,
            voiceChannel: voiceChannel,
            connection: null,
            songs: [],
            volume: 5,
            playing: true
        };
        queue.set(msg.guild.id, queueConstruct);
 
        queueConstruct.songs.push(song);
 
        try {
            var connection = await voiceChannel.join();
            queueConstruct.connection = connection;
            play(msg.guild, queueConstruct.songs[0]);
        } catch (error) {
            console.error(`I could not join the voice channel: ${error}!`);
            queue.delete(msg.guild.id);
            return msg.channel.send(`Can't join this channel: ${error}!`);
        }
    } else {
        serverQueue.songs.push(song);
        console.log(serverQueue.songs);
        if (playlist) return undefined;
        else return msg.channel.send(`**${song.title}**, just added to the queue! `);
    }
    return undefined;
}
 
function play(guild, song) {
    const serverQueue = queue.get(guild.id);
 
    if (!song) {
        serverQueue.voiceChannel.leave();
        queue.delete(guild.id);
        return;
    }
    console.log(serverQueue.songs);
 
    const dispatcher = serverQueue.connection.playStream(ytdl(song.url))
        .on('end', reason => {
            if (reason === 'Stream is not generating quickly enough.') console.log('Song ended.');
            else console.log(reason);
            serverQueue.songs.shift();
            play(guild, serverQueue.songs[0]);
        })
        .on('error', error => console.error(error));
    dispatcher.setVolumeLogarithmic(serverQueue.volume / 5);
 
    serverQueue.textChannel.send(`**${song.title}**, is now playing!`);
}
 
 
client.on('message', message => {
    if (message.content === 'help') {
        let helpEmbed = new Discord.RichEmbed()
        .setTitle('**أوامر الميوزك...**')
        .setDescription('**برفكس البوت (!)**')
        .addField('play', 'لتشغيل اغنية')
        .addField('join', 'دخول رومك الصوتي')
        .addField('disconnect', 'الخروج من رومك الصوتي')
        .addField('skip', 'تخطي الأغنية')
        .addField('pause', 'ايقاف الاغنية مؤقتا')
        .addField('resume', 'تكملة الاغنية')
        .addField('queue', 'اظهار قائمة التشغيل')
        .addField('np', 'اظهار الاغنية اللي انت مشغلها حاليا')
        .setFooter('(general_commands) لاظهار الاوامر العامة')
      message.channel.send(helpEmbed);
    }
});
 
client.on('message', message => {
    if (message.content === 'general_commands') {
        let helpEmbed = new Discord.RichEmbed()
        .setTitle('**أوامر عامة...**')
        .addField('avatar', "افاتار الشخص المطلوب")
        .addField('gif', 'البحث عن جيف انت تطلبه')
        .addField('ping', 'معرفة ping البوت')
        .setFooter('المزيد قريبا ان شاء الله!')
      message.channel.send(helpEmbed);
    }
});

client.login(process.env.BOT_TOKEN);
